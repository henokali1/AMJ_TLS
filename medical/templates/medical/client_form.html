{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}Edit{% else %}New{% endif %} Client - AMJ-TLS{% endblock %}

{% block content %}
<div class="card">
    <header style="margin-bottom: 2rem;">
        <h1 style="font-size: 1.5rem; font-weight: 700;">
            {% if form.instance.pk %}Edit Client Details{% else %}New Medical{% endif %}
        </h1>
        <p style="color: var(--text-light);">Please fill in the client Information below.</p>
    </header>

    <form method="POST" enctype="multipart/form-data" id="clientForm">
        {% csrf_token %}
        
        <div class="form-group">
            <label class="form-label">Client Name</label>
            {{ form.client_name }}
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label class="form-label">Passport No</label>
                {{ form.passport_no }}
            </div>
            <div class="form-group">
                <label class="form-label">Date of Birth</label>
                {{ form.date_of_birth }}
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Registration Date</label>
            {{ form.date }}
        </div>

        <div class="form-group">
            <label class="form-label">Photo (Passport Size)</label>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                {{ form.photo }}
                <div id="cropTargetContainer" style="max-width: 100%; height: 300px; background: #f1f5f9; border-radius: 12px; display: none; overflow: hidden;">
                    <img id="imageToCrop" style="max-width: 100%;">
                </div>
                <div id="previewContainer" style="display: {% if form.instance.photo %}block{% else %}none{% endif %};">
                    <p class="form-label">Preview:</p>
                    <div style="width: 150px; height: 180px; border: 2px solid var(--primary); border-radius: 8px; overflow: hidden; background: #eee;">
                        <img id="cropPreview" src="{% if form.instance.photo %}{{ form.instance.photo.url }}{% endif %}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button type="submit" class="btn btn-primary" id="saveBtn" style="flex: 1;">
                <i class="fas fa-save"></i> Save
            </button>
            <a href="{% url 'client_list' %}" class="btn btn-outline">Cancel</a>
            {% if form.instance.pk %}
                <a href="{% url 'client_delete' form.instance.pk %}" class="btn" style="background: var(--danger); color: white;">
                    <i class="fas fa-trash"></i>
                </a>
            {% endif %}
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    let cropper;
    const fileInput = document.querySelector('input[type="file"]');
    const imageToCrop = document.getElementById('imageToCrop');
    const cropTargetContainer = document.getElementById('cropTargetContainer');
    const previewContainer = document.getElementById('previewContainer');
    const cropPreview = document.getElementById('cropPreview');
    const form = document.getElementById('clientForm');
    let croppedBlob = null;

    fileInput.addEventListener('change', function(e) {
        const files = e.target.files;
        if (files && files.length > 0) {
            const reader = new FileReader();
            reader.onload = function(event) {
                imageToCrop.src = event.target.result;
                cropTargetContainer.style.display = 'block';
                
                if (cropper) {
                    cropper.destroy();
                }
                
                cropper = new Cropper(imageToCrop, {
                    aspectRatio: 3.5 / 4.5, // Standard passport ratio
                    viewMode: 2,
                    autoCropArea: 1,
                    ready: function() {
                        // After initial crop
                        updatePreview();
                    },
                    cropend: function() {
                        updatePreview();
                    }
                });
            };
            reader.readAsDataURL(files[0]);
        }
    });

    function updatePreview() {
        if (!cropper) return;
        
        cropper.getCroppedCanvas({
            width: 350,
            height: 450
        }).toBlob((blob) => {
            croppedBlob = blob;
            const url = URL.createObjectURL(blob);
            cropPreview.src = url;
            previewContainer.style.display = 'block';
        }, 'image/jpeg');
    }

    form.addEventListener('submit', function(e) {
        if (croppedBlob) {
            e.preventDefault();
            const formData = new FormData(form);
            // Replace the photo file with our cropped blob
            formData.set('photo', croppedBlob, 'passport_photo.jpg');
            
            // Re-submit form via fetch or similar? 
            // Standard form submit doesn't allow setting files like this easily.
            // We'll use Fetch to submit and then redirect.
            
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            }).then(response => {
                if (response.ok) {
                    // Use the response URL which follows the server-side redirect (to view_certificate)
                    window.location.href = response.url;
                } else {
                    alert('Error saving client. Please check your data.');
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Client';
                }
            });
        }
    });
</script>
{% endblock %}
